name: Deploy backend to Yandex Serverless Containers

on:
  push:
    branches: [ main ]
    paths:
      - "optimizer_service.py"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/deploy-back.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # OIDC для WIF
      contents: read
    env:
      YC_REGISTRY_ID: ${{ vars.YC_REGISTRY_ID }}         # ID реестра (crp...)
      CR_REPOSITORY:  ${{ vars.CR_REPOSITORY || 'optimizer-back' }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to Yandex Cloud Container Registry (OIDC)
        uses: yc-actions/yc-cr-login@v3
        with:
          yc-sa-id: ${{ secrets.YC_SA_ID }}   # CI-SA, привязанный к федерации

      - name: Compute image ref
        run: |
          echo "IMAGE=cr.yandex/${{ env.YC_REGISTRY_ID }}/${{ env.CR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Build & push image to Yandex CR
        run: |
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy Serverless Container
        uses: yc-actions/yc-sls-container-deploy@v4
        with:
          yc-sa-id: ${{ secrets.YC_SA_ID }}
          folder-id: ${{ secrets.YC_FOLDER_ID }}
          container-name: optimizer-back
          revision-image-url: ${{ env.IMAGE }}
          revision-port: 8080
          revision-execution-timeout: 300
          revision-concurrency: 1
          revision-min-instances: 2
          revision-cores: 2
          revision-core-fraction: 100
          revision-memory: 1024Mb
          revision-service-account-id: ${{ secrets.YC_SA_ID }}
          revision-env: |
            S3_BUCKET=${{ vars.S3_BUCKET }}
            S3_PREFIX=${{ vars.S3_PREFIX }}
            S3_REGION=${{ vars.S3_REGION }}
            S3_ENDPOINT=${{ vars.S3_ENDPOINT }}
            PRESIGN_TTL=${{ vars.S3_PRESIGN_TTL }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Warm up new revision
        env:
          API_BASE: ${{ vars.API_BASE }}
        run: |
          set -e
          URL="${API_BASE%/}/ping"
          echo "Warming $URL"
          for i in {1..90}; do
            code=$(curl -s -o /dev/null -w '%{http_code}' -m 5 "$URL" || echo "000")
            echo "try $i -> $code"
            if [ "$code" = "200" ]; then
              echo "Warm OK"; exit 0
            fi
            # Если стабильно 404 — значит нет маршрута /ping в API GW
            if [ "$code" = "404" ]; then
              echo "Ping path is 404 on API Gateway — add GET /ping route to the container"; exit 1
            fi
            sleep 2
          done
          echo "Warm-up failed"; exit 1
